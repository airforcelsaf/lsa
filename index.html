<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Air Force - App</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:16px}
  .hidden{display:none}
  header{display:flex;justify-content:space-between;align-items:center}
  .card{border:1px solid #ddd;padding:10px;margin:8px;border-radius:8px}
  .btn{padding:8px 12px;border-radius:6px;border:1px solid #666;background:#eee;cursor:pointer}
  .list-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
  img.badge{width:36px;height:36px;margin-right:8px}
  .row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>

<div id="loginView">
  <h1>Inicio de sesión - LSAF</h1>
  <label>Email<br><input id="email" value="david_toro@lsaf.gov.us"/></label><br>
  <label>Contraseña<br><input id="password" type="password" value="12345"/></label><br><br>
  <button id="btnLogin" class="btn">Entrar</button>
  <div id="loginMsg"></div>
</div>

<div id="appView" class="hidden">
  <header>
    <h2>Air Force - Panel</h2>
    <div>
      <span id="userName"></span>
      <button id="btnLogout" class="btn">Cerrar sesión</button>
    </div>
  </header>

  <nav class="card">
    <button class="btn menuBtn" data-view="pilotosView">PILOTOS</button>
    <button class="btn menuBtn" data-view="aeronavesView">AERONAVES</button>
    <button class="btn menuBtn" data-view="librosView">LIBROS DE VUELO</button>
    <button class="btn menuBtn" data-view="solicitudesView">SOLICITUDES</button>
    <button class="btn menuBtn" data-view="resumenView">RESUMEN</button>
    <button class="btn menuBtn" data-view="rangosView">RANGOS</button>
  </nav>

  <!-- PILOTOS -->
  <section id="pilotosView" class="card view">
    <h3>Pilotos <button id="btnAddPiloto" class="btn">Agregar piloto</button></h3>
    <div id="pilotosList"></div>
  </section>

  <!-- AERONAVES (esqueleto) -->
  <section id="aeronavesView" class="card view hidden">
    <h3>Aeronaves <button id="btnAddAeronave" class="btn">Agregar aeronave</button></h3>
    <div id="aeronavesList"></div>
  </section>

  <!-- LIBROS -->
  <section id="librosView" class="card view hidden">
    <h3>Libros de vuelo <button id="btnAddLibro" class="btn">Agregar libro de vuelo</button></h3>
    <div id="librosList"></div>
  </section>

  <!-- SOLICITUDES -->
  <section id="solicitudesView" class="card view hidden">
    <h3>Solicitudes <button id="btnSolicitar" class="btn">Solicitar certificación</button></h3>
    <div id="solicitudesList"></div>
  </section>

  <!-- RESUMEN -->
  <section id="resumenView" class="card view hidden">
    <h3>Resumen</h3>
    <div id="resumenContent"></div>
  </section>

  <!-- RANGOS -->
  <section id="rangosView" class="card view hidden">
    <h3>Rangos <button id="btnAddRango" class="btn">Agregar rango</button></h3>
    <div id="rangosList"></div>
  </section>
</div>

<!-- Modales / Formularios sencillos -->
<div id="modal" class="hidden card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;z-index:20;">
  <div id="modalContent"></div>
  <div style="text-align:right;margin-top:8px"><button id="modalClose" class="btn">Cerrar</button></div>
</div>

<script>
  // =========== CONFIG ===========
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw1H4abZDt74guvJHxCR9pu9JPfW8Q1mj_rsGcOsI6A8wnTmphyIP7ycLJCE5tvztKt9Q/exec"; // pega la url de tu Apps Script /exec
  // ==============================
  let currentUser = null;

  // util fetch wrapper
  async function api(path, method='GET', body=null){
    const url = SCRIPT_URL + (path ? "?path=" + encodeURIComponent(path) : "");
    const opts = { method: method, headers: { "Content-Type": "application/json" } };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(url, opts);
    const j = await res.json();
    return j;
  }

  // login
  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const r = await api('login','POST',{email,password});
    if (r.ok){ currentUser = r.user; showApp(); loadPilotos(); document.getElementById('userName').innerText = currentUser.nombre_completo || currentUser.email; }
    else document.getElementById('loginMsg').innerText = "Error: " + r.error;
  });

  document.getElementById('btnLogout').addEventListener('click', ()=>{
    currentUser = null; document.getElementById('appView').classList.add('hidden'); document.getElementById('loginView').classList.remove('hidden');
  });

  function showApp(){
    document.getElementById('loginView').classList.add('hidden');
    document.getElementById('appView').classList.remove('hidden');
    showView('pilotosView');
  }

  // nav
  document.querySelectorAll('.menuBtn').forEach(b=>{
    b.addEventListener('click', ()=> showView(b.dataset.view));
  });
  function showView(id){
    document.querySelectorAll('.view').forEach(v=> v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  // PILOTOS - carga lista
  async function loadPilotos(){
    const r = await api('getPilotos');
    if (!r || !Array.isArray(r)) { document.getElementById('pilotosList').innerText = 'Error al cargar'; return; }
    const container = document.getElementById('pilotosList');
    container.innerHTML = '';
    r.forEach(p=>{
      const div = document.createElement('div');
      div.className = "list-item";
      div.innerHTML = `<div class="row"><img class="badge" src="${p.foto_url || 'https://via.placeholder.com/36'}" alt=""><div><strong>${p.nombre_completo||p.email}</strong><br><small>${p.nuim || ''}</small></div></div>
        <div><button class="btn" onclick='openPerfil("${p.id}")'>Ver perfil</button></div>`;
      container.appendChild(div);
    });
  }

  // abrir perfil (esqueleto)
  window.openPerfil = async function(pilotoId){
    // buscar en la lista cargada o pedir al API una ruta específica (no implementada en backend demo)
    const r = await api('getPilotos');
    const piloto = r.find(x => x.id === pilotoId);
    if (!piloto) return alert('Piloto no encontrado');
    showModal(`<h3>Perfil: ${piloto.nombre_completo}</h3>
      <img src="${piloto.foto_url||''}" style="width:120px"><p>Rango: ${piloto.rango_id || ''}</p>
      <p>NUIM: ${piloto.nuim || ''}</p>
      <p>Nacimiento: ${piloto.fecha_nacimiento || ''}</p>
      <p>Teléfono: ${piloto.telefono || ''}</p>
      <p>Tipo sangre: ${piloto.tipo_sangre || ''}</p>
      <hr>
      <div><button class="btn" onclick="editPiloto('${piloto.id}')">Editar piloto</button></div>
      `);
  };

  function editPiloto(id){
    // implementar formulario de edición que haga POST a addPiloto o update (update no implementado en ejemplo)
    alert("Función editar no implementada en este ejemplo. Edita en Sheets por ahora.");
  }

  // Modal helpers
  function showModal(html){
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('modal').classList.remove('hidden');
  }
  document.getElementById('modalClose').addEventListener('click', ()=> document.getElementById('modal').classList.add('hidden'));

  // Agregar piloto (simple)
  document.getElementById('btnAddPiloto').addEventListener('click', ()=>{
    showModal(`<h3>Agregar piloto</h3>
      <label>Nombre<br><input id="np_nombre"></label><br>
      <label>Email<br><input id="np_email"></label><br>
      <label>NUIM<br><input id="np_nuim"></label><br>
      <label>Rango ID<br><input id="np_rango"></label><br>
      <label>Foto URL<br><input id="np_foto"></label><br><br>
      <button class="btn" onclick="submitAddPiloto()">Agregar</button>`);
  });

  window.submitAddPiloto = async function(){
    const nombre = document.getElementById('np_nombre').value;
    const email = document.getElementById('np_email').value;
    const nuim = document.getElementById('np_nuim').value;
    const rango = document.getElementById('np_rango').value;
    const foto = document.getElementById('np_foto').value;
    const payload = { nombre_completo: nombre, email: email, nuim: nuim, rango_id: rango, foto_url: foto, password: "12345" };
    const r = await api('addPiloto','POST', payload);
    if (r.ok){ alert('Piloto agregado: ' + r.id); document.getElementById('modal').classList.add('hidden'); loadPilotos(); }
    else alert('Error: ' + r.error);
  };

  // carga inicial (si tuvieras token local, restaurar sesión)
  // loadPilotos(); // no cargar hasta login

</script>
</body>
</html>
