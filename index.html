<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LSAF — Panel</title>
  <style>
    /* Styling sencillo inspirado en Air Force — tonos azules, tipografía clara */
    :root{
      --bg:#0b1220; --card:#0f2436; --accent:#2b7cff; --muted:#a9c3da; --glass: rgba(255,255,255,0.04);
      --success: #2ecc71;
    }
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#041026,#07172a);color:#eaf6ff;}
    .container{max-width:1100px;margin:24px auto;padding:16px;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    header h1{font-size:20px;margin:0;color:var(--accent)}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4);}
    .login{max-width:420px;margin:48px auto;padding:18px;}
    input,select,textarea{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #23414f;background:transparent;color:#eaf6ff}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .piloto-row{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;margin-bottom:8px;background:var(--glass)}
    .piloto-row img{width:48px;height:48px;object-fit:cover;border-radius:6px;border:2px solid rgba(255,255,255,0.03)}
    .piloto-info{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    nav{display:flex;gap:8px}
    nav button{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px}
    .list{max-height:60vh;overflow:auto;padding:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>LSAF — Panel</h1>
      <div id="userDisplay"></div>
    </header>

    <div id="loginView" class="card login">
      <h2>Iniciar sesión</h2>
      <input id="loginEmail" placeholder="usuario@lsaf.gov.us" />
      <input id="loginPass" type="password" placeholder="Contraseña" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnLogin">Entrar</button>
        <button id="btnDemo" class="btn-ghost">Entrar demo (sin backend)</button>
      </div>
      <p class="small">Usa el email y contraseña registrados en tu hoja MIEMBROS.</p>
      <div id="loginMsg" class="small" style="color:#ffbaba"></div>
    </div>

    <div id="appView" class="hidden">
      <nav>
        <button data-view="pilotos">Pilotos</button>
        <button data-view="aeronaves">Aeronaves</button>
        <button data-view="libros">Libros de vuelo</button>
        <button data-view="solicitudes">Solicitudes</button>
        <button data-view="resumen">Resumen</button>
        <button data-view="rangos">Rangos</button>
        <button id="btnLogout" style="margin-left:12px">Cerrar sesión</button>
      </nav>

      <div style="margin-top:12px" class="grid">
        <div class="card" id="mainPanel">
          <!-- contenido dinámico -->
        </div>

        <div class="card" id="sidePanel">
          <div id="sideContent">Panel lateral</div>
        </div>
      </div>
    </div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx2Q7qHKmKJRpzlC4s2g4pMkWDuEs3tATAcKLSVekQAtO4mYi57d7FWmD2bXgyDow6nTw/exec'; // <-- REEMPLAZAR
let CURRENT_USER = null;

// util fetch
async function apiGet(action, params={}) {
  const url = new URL(WEB_APP_URL);
  url.searchParams.set('action', action);
  for(const k in params) url.searchParams.set(k, params[k]);
  const res = await fetch(url);
  return res.json();
}
async function apiPost(action, payload) {
  const res = await fetch(WEB_APP_URL, {
    method:'POST',
    body: JSON.stringify(Object.assign({action}, payload)),
    headers:{'Content-Type':'application/json'}
  });
  return res.json();
}

/* ---- Login ---- */
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPass').value;
  document.getElementById('loginMsg').textContent = 'Autenticando...';
  try {
    const r = await apiGet('login', {email, password: pass});
    if(r.ok && r.data && r.data.user){
      CURRENT_USER = r.data.user;
      loadApp();
    } else {
      document.getElementById('loginMsg').textContent = r.data?.error || r.error || 'Error de login';
    }
  } catch(err) {
    document.getElementById('loginMsg').textContent = err.message;
  }
});
document.getElementById('btnDemo').addEventListener('click', ()=>{
  CURRENT_USER = {NOMBRE:'Demo Piloto', EMAIL:'demo@lsaf.gov.us', NUIM:'0000', ROL:'ADMIN'};
  loadApp();
});

function loadApp(){
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('appView').classList.remove('hidden');
  document.getElementById('userDisplay').textContent = CURRENT_USER ? (CURRENT_USER.NOMBRE + ' — ' + CURRENT_USER.ROL) : '';
  // cargar vista default
  setupNav();
  showView('pilotos');
}

function setupNav(){
  document.querySelectorAll('nav button[data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=> showView(btn.dataset.view));
  });
  document.getElementById('btnLogout').addEventListener('click', ()=>{
    CURRENT_USER = null;
    document.getElementById('appView').classList.add('hidden');
    document.getElementById('loginView').classList.remove('hidden');
  });
}

/* ---- Vistas ---- */

async function showView(view){
  const main = document.getElementById('mainPanel');
  const side = document.getElementById('sideContent');
  main.innerHTML = '<h3>Cargando...</h3>';
  side.innerHTML = '';
  if(view === 'pilotos') {
    const r = await apiGet('getPilotos');
    const data = (r.ok && r.data) ? r.data : [];
    renderPilotos(data);
  } else if(view === 'aeronaves'){
    const r = await apiGet('getAeronaves');
    renderAeronaves(r.data || []);
  } else if(view === 'libros'){
    const r = await apiGet('getLibros');
    renderLibros(r.data || []);
  } else if(view === 'solicitudes'){
    const r = await apiGet('getSolicitudes');
    renderSolicitudes(r.data || []);
  } else if(view === 'rangos'){
    const r = await apiGet('getRangos');
    renderRangos(r.data || []);
  } else if(view === 'resumen'){
    renderResumen();
  }
}

/* PILOTOS */
function renderPilotos(pilotos){
  const main = document.getElementById('mainPanel');
  main.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><h3>Pilotos</h3><button id="btnAddPiloto">AGREGAR PILOTO</button></div><div class="list" id="pilotosList"></div>';
  const list = document.getElementById('pilotosList');
  pilotos.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'piloto-row';
    div.innerHTML = `
      <img src="${p.RANGO_IMG_URL || 'https://via.placeholder.com/48'}" alt="insignia" />
      <div class="piloto-info">
        <div style="font-weight:600">${p.NOMBRE}</div>
        <div class="small">${p.NUIM}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-ghost viewPiloto" data-nuim="${p.NUIM}">Ver</button>
        <button class="btn-ghost editPiloto" data-nuim="${p.NUIM}">Editar</button>
      </div>
    `;
    list.appendChild(div);
  });

  document.getElementById('btnAddPiloto').addEventListener('click', ()=> showAddPilotoForm());
  document.querySelectorAll('.viewPiloto').forEach(b=> b.addEventListener('click', e=>{
    const nuim = e.currentTarget.dataset.nuim;
    showPilotoProfile(nuim);
  }));
  document.querySelectorAll('.editPiloto').forEach(b=> b.addEventListener('click', e=>{
    const nuim = e.currentTarget.dataset.nuim;
    showEditPilotoForm(nuim);
  }));
}

function showAddPilotoForm(){
  const main = document.getElementById('mainPanel');
  main.innerHTML = `<h3>Agregar Piloto</h3>
    <div>
      <input id="p_NOMBRE" placeholder="PILOTO (Nombre completo)"/>
      <input id="p_EMAIL" placeholder="EMAIL (nombre_apellido@lsaf.gov.us)"/>
      <input id="p_NUIM" placeholder="NUIM"/>
      <label class="small">FECHA DE INGRESO</label>
      <input id="p_FECHA_INGRESO" type="date"/>
      <label class="small">ROL</label>
      <select id="p_ROL"><option>ADMIN</option><option>INSTRUCTOR</option><option>PILOTO</option></select>
      <label class="small">ESTADO</label>
      <select id="p_ESTADO"><option>ACTIVO</option><option>ARCHIVADO</option></select>
      <input id="p_RANGO" placeholder="RANGO (ej. Capitan)"/>
      <input id="p_RANGO_IMG_URL" placeholder="URL insignia"/>
      <input id="p_PASSWORD" placeholder="Contraseña (temporal)"/>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="savePiloto">GUARDAR PILOTO</button>
        <button id="cancelPiloto" class="btn-ghost">CANCELAR REGISTRO</button>
      </div>
    </div>`;
  document.getElementById('cancelPiloto').addEventListener('click', ()=> showView('pilotos'));
  document.getElementById('savePiloto').addEventListener('click', async ()=>{
    const payload = {
      NOMBRE: document.getElementById('p_NOMBRE').value,
      EMAIL: document.getElementById('p_EMAIL').value,
      NUIM: document.getElementById('p_NUIM').value,
      FECHA_INGRESO: document.getElementById('p_FECHA_INGRESO').value,
      ROL: document.getElementById('p_ROL').value,
      ESTADO: document.getElementById('p_ESTADO').value,
      RANGO: document.getElementById('p_RANGO').value,
      RANGO_IMG_URL: document.getElementById('p_RANGO_IMG_URL').value,
      PASSWORD: document.getElementById('p_PASSWORD').value
    };
    const r = await apiPost('addPiloto', payload);
    if(r.ok) showView('pilotos'); else alert('Error: ' + (r.error||r.message));
  });
}

async function showPilotoProfile(nuim){
  const r = await apiGet('getPiloto', {nuim});
  const p = (r.ok && r.data) ? r.data : null;
  const main = document.getElementById('mainPanel');
  if(!p){ main.innerHTML = '<p>Piloto no encontrado</p>'; return; }
  main.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3>PILOTO</h3>
        <div style="font-weight:700">${p.NOMBRE}</div>
        <div class="small">NUIM: ${p.NUIM}</div>
        <div class="small">RANGO: ${p.RANGO || ''}</div>
        <div class="small">EMAIL: ${p.EMAIL || ''}</div>
      </div>
      <div style="display:flex;gap:8px;flex-direction:column;align-items:flex-end">
        <button id="editProfile">EDITAR PILOTO</button>
      </div>
    </div>
    <hr/>
    <h4>FICHA DEL PILOTO</h4>
    <div style="display:flex;gap:12px">
      <img src="${p.IMAGEN_URL || 'https://via.placeholder.com/120'}" style="width:120px;height:120px;object-fit:cover;border-radius:6px" />
      <div>
        <div class="small">FECHA DE NACIMIENTO</div><div>${p.FECHA_NACIMIENTO || '-'}</div>
        <div class="small">TIPO DE SANGRE</div><div>${p.TIPO_SANGRE || '-'}</div>
        <div class="small">NACIONALIDAD</div><div>${p.NACIONALIDAD || '-'}</div>
      </div>
    </div>

    <h4 style="margin-top:12px">ASCENSOS Y DESCENSOS</h4>
    <div id="ascensosBox" class="card" style="padding:8px">(Se mostrará lista de ascensos — esta versión inicial no trae ascensos separados)</div>

    <h4 style="margin-top:12px">LIBROS DE VUELO RELACIONADOS</h4>
    <div id="librosRelacionados" class="card" style="padding:8px">Cargando libros...</div>

    <h4 style="margin-top:12px">SOLICITUDES RELACIONADAS</h4>
    <div id="solicitudesRelacionadas" class="card" style="padding:8px">Cargando solicitudes...</div>

    <h4 style="margin-top:12px">RESUMEN DE TIEMPOS</h4>
    <div>TIEMPO TOTAL DE VUELO: ${p.TIEMPO_TOTAL || 0} minutos</div>
  `;

  document.getElementById('editProfile').addEventListener('click', ()=> showEditFicha(p.NUIM));

  // cargar libros del piloto
  const lr = await apiGet('getLibros');
  const libros = (lr.ok && lr.data) ? lr.data.filter(l=> String(l.PILOTO_NUIM) === String(p.NUIM)) : [];
  const librosBox = document.getElementById('librosRelacionados');
  librosBox.innerHTML = libros.length ? libros.map(lb=> `<div class="small">${lb.LIBRO_ID} — ${lb.AERONAVE_ID} — ${lb.TIEMPO_TOTAL_MIN} min</div>`).join('') : 'No hay libros';

  // solicitudes relacionadas
  const sr = await apiGet('getSolicitudes');
  const sols = (sr.ok && sr.data) ? sr.data.filter(s=> String(s.PILOTO_NUIM) === String(p.NUIM)) : [];
  const solsBox = document.getElementById('solicitudesRelacionadas');
  solsBox.innerHTML = sols.length ? sols.map(s=> `<div class="small">${s.SOLICITUD_ID} — ${s.AERONAVE_ID} — ${s.ESTADO}</div>`).join('') : 'No hay solicitudes';
}

function showEditPilotoForm(nuim){
  // obtener datos y mostrar form similar a add
  apiGet('getPiloto', {nuim}).then(r=>{
    const p = r.data;
    const main = document.getElementById('mainPanel');
    main.innerHTML = `<h3>Editar Piloto</h3>
      <input id="e_NOMBRE" value="${p.NOMBRE}"/>
      <input id="e_EMAIL" value="${p.EMAIL}" disabled/>
      <input id="e_NUIM" value="${p.NUIM}" />
      <label class="small">FECHA DE INGRESO</label>
      <input id="e_FECHA_INGRESO" type="date" value="${p.FECHA_INGRESO || ''}"/>
      <label class="small">ROL</label>
      <select id="e_ROL"><option ${p.ROL==='ADMIN'?'selected':''}>ADMIN</option><option ${p.ROL==='INSTRUCTOR'?'selected':''}>INSTRUCTOR</option><option ${p.ROL==='PILOTO'?'selected':''}>PILOTO</option></select>
      <label class="small">ESTADO</label>
      <select id="e_ESTADO"><option ${p.ESTADO==='ACTIVO'?'selected':''}>ACTIVO</option><option ${p.ESTADO==='ARCHIVADO'?'selected':''}>ARCHIVADO</option></select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveEdit">GUARDAR</button>
        <button id="cancelEdit" class="btn-ghost">CANCELAR</button>
      </div>
    `;
    document.getElementById('cancelEdit').addEventListener('click', ()=> showView('pilotos'));
    document.getElementById('saveEdit').addEventListener('click', async ()=>{
      const payload = {
        NOMBRE: document.getElementById('e_NOMBRE').value,
        EMAIL: p.EMAIL,
        NUIM: document.getElementById('e_NUIM').value,
        FECHA_INGRESO: document.getElementById('e_FECHA_INGRESO').value,
        ROL: document.getElementById('e_ROL').value,
        ESTADO: document.getElementById('e_ESTADO').value
      };
      const r2 = await apiPost('editPiloto', payload);
      if(r2.ok) {
        if(payload.ESTADO === 'ARCHIVADO') {
          await apiPost('archivePiloto', {nuim: payload.NUIM});
        }
        showView('pilotos');
      } else alert('Error: '+(r2.error||r2.message));
    });
  });
}

function showEditFicha(nuim){
  apiGet('getPiloto', {nuim}).then(r=>{
    const p = r.data;
    const main = document.getElementById('mainPanel');
    main.innerHTML = `<h3>Editar Ficha</h3>
      <img src="${p.IMAGEN_URL || 'https://via.placeholder.com/120'}" style="width:120px;height:120px;object-fit:cover;border-radius:6px" />
      <div class="small">PILOTO (no editable)</div><div>${p.NOMBRE}</div>
      <div class="small">EMAIL (no editable)</div><div>${p.EMAIL}</div>
      <label class="small">FECHA DE NACIMIENTO</label><input id="f_FECHA_NACIMIENTO" type="date" value="${p.FECHA_NACIMIENTO||''}"/>
      <input id="f_TIPO_SANGRE" value="${p.TIPO_SANGRE||''}" placeholder="Tipo de sangre"/>
      <input id="f_NACIONALIDAD" value="${p.NACIONALIDAD||''}" placeholder="Nacionalidad"/>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="saveFicha">GUARDAR</button><button id="cancelFicha" class="btn-ghost">CANCELAR</button></div>
    `;
    document.getElementById('cancelFicha').addEventListener('click', ()=> showPilotoProfile(nuim));
    document.getElementById('saveFicha').addEventListener('click', async ()=>{
      const payload = {
        NOMBRE: p.NOMBRE,
        EMAIL: p.EMAIL,
        NUIM: p.NUIM,
        FECHA_NACIMIENTO: document.getElementById('f_FECHA_NACIMIENTO').value,
        TIPO_SANGRE: document.getElementById('f_TIPO_SANGRE').value,
        NACIONALIDAD: document.getElementById('f_NACIONALIDAD').value
      };
      const r2 = await apiPost('editPiloto', payload);
      if(r2.ok) showPilotoProfile(p.NUIM); else alert('Error: ' + (r2.error||r2.message));
    });
  });
}

/* AERONAVES */
function renderAeronaves(aeronaves){
  const main = document.getElementById('mainPanel');
  main.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><h3>Aeronaves</h3><button id="btnAddAero">AGREGAR AERONAVE</button></div><div id="aeroList" class="list"></div>';
  const list = document.getElementById('aeroList');
  aeronaves.forEach(a=>{
    const div = document.createElement('div');
    div.className='piloto-row';
    div.innerHTML = `
      <img src="${a.IMG_URL||'https://via.placeholder.com/48'}" />
      <div class="piloto-info">
        <div style="font-weight:700">${a.CALLSIGN || a.ID_AERO}</div>
        <div class="small">${a.MODELO || ''}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-ghost editAero" data-id="${a.ID_AERO}">Editar</button>
        <button class="btn-ghost delAero" data-id="${a.ID_AERO}">Eliminar</button>
      </div>
    `;
    list.appendChild(div);
  });
  document.getElementById('btnAddAero').addEventListener('click', ()=> {
    showAddAeronaveForm();
  });
  document.querySelectorAll('.editAero').forEach(b=> b.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id;
    showEditAeronaveForm(id);
  }));
  document.querySelectorAll('.delAero').forEach(b=> b.addEventListener('click', e=>{
    alert('Eliminar no implementado en esta versión. Puedes editar el campo DISPONIBLE en sheets.');
  }));
}

function showAddAeronaveForm(){
  const main = document.getElementById('mainPanel');
  main.innerHTML = `<h3>Agregar Aeronave</h3>
    <input id="a_ID_AERO" placeholder="ID_AERO"/>
    <input id="a_CALLSIGN" placeholder="CALLSING"/>
    <input id="a_MODELO" placeholder="MODELO"/>
    <input id="a_IMG_URL" placeholder="URL imagen"/>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="saveAero">GUARDAR</button><button id="cancelAero" class="btn-ghost">CANCELAR</button></div>
  `;
  document.getElementById('cancelAero').addEventListener('click', ()=> showView('aeronaves'));
  document.getElementById('saveAero').addEventListener('click', async ()=>{
    const payload = {
      ID_AERO: document.getElementById('a_ID_AERO').value,
      CALLSIGN: document.getElementById('a_CALLSIGN').value,
      MODELO: document.getElementById('a_MODELO').value,
      IMG_URL: document.getElementById('a_IMG_URL').value,
      DISPONIBLE: 'SI'
    };
    const r = await apiPost('addAeronave', payload);
    if(r.ok) showView('aeronaves'); else alert('Error: '+(r.error||r.message));
  });
}

function showEditAeronaveForm(id){
  apiGet('getAeronaves').then(r=>{
    const aero = (r.ok?r.data:[]).find(a=>a.ID_AERO===id);
    if(!aero) return alert('Aeronave no encontrada');
    const main = document.getElementById('mainPanel');
    main.innerHTML = `<h3>Editar Aeronave</h3>
      <input id="e_ID_AERO" value="${aero.ID_AERO}" disabled/>
      <input id="e_CALLSIGN" value="${aero.CALLSIGN}"/>
      <input id="e_MODELO" value="${aero.MODELO}"/>
      <input id="e_IMG_URL" value="${aero.IMG_URL}"/>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="saveAeroEdit">GUARDAR</button><button id="cancelAeroEdit" class="btn-ghost">CANCELAR</button></div>
    `;
    document.getElementById('cancelAeroEdit').addEventListener('click', ()=> showView('aeronaves'));
    document.getElementById('saveAeroEdit').addEventListener('click', async ()=>{
      const payload = {
        ID_AERO: aero.ID_AERO,
        CALLSIGN: document.getElementById('e_CALLSIGN').value,
        MODELO: document.getElementById('e_MODELO').value,
        IMG_URL: document.getElementById('e_IMG_URL').value
      };
      const r2 = await apiPost('editAeronave', payload);
      if(r2.ok) showView('aeronaves'); else alert('Error');
    });
  });
}

/* LIBROS */
function renderLibros(libros){
  const main = document.getElementById('mainPanel');
  // ordenar descendente por LIBRO_ID
  libros.sort((a,b)=>(b.LIBRO_ID||'').localeCompare(a.LIBRO_ID||''));
  main.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>Libros de vuelo</h3><button id="btnAddLibro">REGISTRAR LIBRO DE VUELO</button></div><div id="librosList" class="list"></div>`;
  const list = document.getElementById('librosList');
  libros.forEach(l=>{
    const div = document.createElement('div');
    div.className='piloto-row';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:700">${l.LIBRO_ID}</div><div class="small">${l.AERONAVE_ID} — ${l.FECHA_SUBIDA || ''}</div></div><div>${l.TIEMPO_TOTAL_MIN || 0} min</div>`;
    list.appendChild(div);
  });
  document.getElementById('btnAddLibro').addEventListener('click', ()=> showAddLibroForm());
}

function showAddLibroForm(){
  const main = document.getElementById('mainPanel');
  main.innerHTML = `<h3>Registrar Libro de Vuelo</h3>
    <div class="small">LIBRO_ID: (se generará automáticamente)</div>
    <div class="small">PILOTO: ${CURRENT_USER.NOMBRE}</div>
    <input id="l_AERONAVE_ID" placeholder="AERONAVE_ID (ej AERO-0001)"/>
    <label class="small">HORA DESPEGUE</label><input id="l_DESPEGUE" type="datetime-local"/>
    <label class="small">HORA ATERRIZAJE</label><input id="l_ATERRIZAJE" type="datetime-local"/>
    <input id="l_RUTA" placeholder="RUTA"/>
    <input id="l_MOTIVO" placeholder="MOTIVO"/>
    <textarea id="l_OBS" placeholder="OBSERVACIONES"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="sendLibro">ENVIAR LIBRO DE VUELO</button><button class="btn-ghost" id="cancelLibro">CANCELAR</button></div>
  `;
  document.getElementById('cancelLibro').addEventListener('click', ()=> showView('libros'));
  document.getElementById('sendLibro').addEventListener('click', async ()=>{
    const payload = {
      PILOTO_NUIM: CURRENT_USER.NUIM,
      AERONAVE_ID: document.getElementById('l_AERONAVE_ID').value,
      HORA_DESPEGUE: new Date(document.getElementById('l_DESPEGUE').value).toISOString(),
      HORA_ATERRIZAJE: new Date(document.getElementById('l_ATERRIZAJE').value).toISOString(),
      RUTA: document.getElementById('l_RUTA').value,
      MOTIVO: document.getElementById('l_MOTIVO').value,
      OBSERVACIONES: document.getElementById('l_OBS').value
    };
    try {
      const r = await apiPost('addLibro', payload);
      if(r.ok) showView('libros'); else alert(r.error || r.message);
    } catch(err){ alert(err.message); }
  });
}

/* SOLICITUDES */
function renderSolicitudes(sols){
  const main = document.getElementById('mainPanel');
  main.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>Solicitudes</h3><button id="btnReqCert">SOLICITAR CERTIFICACION</button></div><div id="solList" class="list"></div>`;
  const list = document.getElementById('solList');
  sols.forEach(s=>{
    const div = document.createElement('div');
    div.className='piloto-row';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:700">${s.SOLICITUD_ID}</div><div class="small">${s.PILOTO_NOMBRE} — ${s.AERONAVE_ID}</div><div class="small">${s.ESTADO}</div></div>
    <div style="display:flex;flex-direction:column;gap:6px">
      ${s.ESTADO === 'ABIERTA' ? `<button class="btn-ghost takeReq" data-id="${s.SOLICITUD_ID}">TOMAR SOLICITUD</button>`: ''}
      ${s.ESTADO && s.ESTADO.indexOf('TOMADA_POR')===0 ? `<div class="small"> ${s.ESTADO}</div><button class="btn-ghost certifyReq" data-id="${s.SOLICITUD_ID}">CERTIFICAR</button>` : ''}
    </div>`;
    list.appendChild(div);
  });
  document.getElementById('btnReqCert').addEventListener('click', ()=> showAddSolicitudForm());
  document.querySelectorAll('.takeReq').forEach(b=> b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    const r = await apiPost('takeSolicitud', {SOLICITUD_ID: id, TOMADA_POR_NUIM: CURRENT_USER.NUIM, TOMADA_POR_NOMBRE: CURRENT_USER.NOMBRE});
    if(r.ok) showView('solicitudes'); else alert('Error');
  }));
  document.querySelectorAll('.certifyReq').forEach(b=> b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    const r = await apiPost('certifySolicitud', {SOLICITUD_ID: id, CERTIFICADOR_NUIM: CURRENT_USER.NUIM});
    if(r.ok) showView('solicitudes'); else alert('Error');
  }));
}

function showAddSolicitudForm(){
  const main = document.getElementById('mainPanel');
  main.innerHTML = `<h3>Solicitar Certificación</h3>
    <div class="small">SOLICITUD ID: (se generará autom.)</div>
    <div class="small">PILOTO: ${CURRENT_USER.NOMBRE}</div>
    <input id="s_AERONAVE_ID" placeholder="AERONAVE_ID"/>
    <input id="s_DISPONIBILIDAD" placeholder="Disponibilidad (ej: 2025-09-24 18:00)"/>
    <div style="margin-top:8px"><label><input type="checkbox" id="s_CARTA"/> Acepto la <a href="https://docs.google.com/document/d/1KatX3AWuzmWhmYO-Z-SyaedXsY6YgsgE1_tB9AcaQ4c/edit?usp=drive_link" target="_blank">CARTA DE COMPROMISO</a></label></div>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="saveSolicitud">SI</button><button id="cancelSolicitud" class="btn-ghost">NO</button></div>
  `;
  document.getElementById('cancelSolicitud').addEventListener('click', ()=> showView('solicitudes'));
  document.getElementById('saveSolicitud').addEventListener('click', async ()=>{
    const carta = document.getElementById('s_CARTA').checked ? 'SI' : 'NO';
    if(carta !== 'SI') return alert('Debe estar de acuerdo con la carta de compromiso');
    const payload = {
      PILOTO_NUIM: CURRENT_USER.NUIM,
      PILOTO_NOMBRE: CURRENT_USER.NOMBRE,
      RANGO: CURRENT_USER.RANGO || '',
      AERONAVE_ID: document.getElementById('s_AERONAVE_ID').value,
      DISPONIBILIDAD: document.getElementById('s_DISPONIBILIDAD').value,
      CARTA_ACEPTADA: 'SI'
    };
    const r = await apiPost('addSolicitud', payload);
    if(r.ok) showView('solicitudes'); else alert('Error: '+(r.error||r.message));
  });
}

/* RANGOS */
function renderRangos(rangos){
  const main = document.getElementById('mainPanel');
  main.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>Rangos</h3><button id="btnAddRango">AGREGAR RANGO</button></div><div id="rList" class="list"></div>`;
  const list = document.getElementById('rList');
  rangos.forEach(r=>{
    const div = document.createElement('div');
    div.className='piloto-row';
    div.innerHTML = `<img src="${r.IMG_URL||'https://via.placeholder.com/48'}" />
      <div class="piloto-info"><div style="font-weight:700">${r.NOMBRE_RANGO}</div><div class="small">Escalafon: ${r.ESCALAFON}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px"><button class="btn-ghost editR" data-name="${r.NOMBRE_RANGO}">Editar</button><button class="btn-ghost delR" data-name="${r.NOMBRE_RANGO}">Eliminar</button></div>`;
    list.appendChild(div);
  });
  document.getElementById('btnAddRango').addEventListener('click', ()=> alert('Agregar rango: implementable via Apps Script (add row en RANGOS)'));
}

/* RESUMEN */
async function renderResumen(){
  // carga datos agregados simples
  const p = await apiGet('getPilotos');
  const l = await apiGet('getLibros');
  const a = await apiGet('getAeronaves');
  const main = document.getElementById('mainPanel');
  const pilotos = (p.ok?p.data:[]).length;
  const totalMin = (l.ok? l.data.reduce((s,x)=> s + (Number(x.TIEMPO_TOTAL_MIN)||0),0):0);
  main.innerHTML = `<h3>Resumen</h3><div class="small">LIDER: (configurable en hoja RESUMEN)</div><div>Pilotos: ${pilotos}</div><div>Tiempo total de vuelo (min): ${totalMin}</div><h4>Horas por Aeronave</h4><div id="legendAero"></div>`;
  const legend = document.getElementById('legendAero');
  const aeroMap = {};
  (l.ok?l.data:[]).forEach(lb=>{
    aeroMap[lb.AERONAVE_ID] = (aeroMap[lb.AERONAVE_ID] || 0) + Number(lb.TIEMPO_TOTAL_MIN || 0);
  });
  legend.innerHTML = Object.keys(aeroMap).map(k=> `<div class="small">${k}: ${aeroMap[k]} min</div>`).join('');
}

/* RUTINAS INICIALES */
(async ()=>{
  // ping backend
  try {
    const p = await apiGet('ping');
    console.log('backend ping', p);
  } catch(err){
    console.warn('No se pudo contactar backend. Asegúrate de haber desplegado el Apps Script y de haber reemplazado WEB_APP_URL');
  }
})();
</script>
</body>
</html>
